<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.33.xsd">

    <changeSet id="1" author="Michal">
        <createTable tableName="users">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2" author="Michal">
        <createTable tableName="flashcard_sets">
        <column name="id" type="SERIAL" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="name" type="VARCHAR(40)">
            <constraints nullable="false"/>
        </column>
        <column name="description" type="TEXT"/>
        <column name="is_public" type="BOOLEAN" defaultValueBoolean="false">
            <constraints nullable="false"/>
        </column>
        <column name="owner_id" type="INT">
            <constraints nullable="false" foreignKeyName="fk_set_owner" references="users(id)"/>
        </column>
        </createTable>
    </changeSet>

    <changeSet id="3" author="Michal">
        <createTable tableName="flashcards">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="front_content" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="back_content" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="set_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_flashcard_set" references="flashcard_sets(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="4" author="Michal">
        <createTable tableName="materials">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="item_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_material_owner" references="users(id)"/>
            </column>
            <column name="parent_id" type="INT">
                <constraints nullable="true" foreignKeyName="fk_material_parent" references="materials(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="5" author="Michal">
        <dropForeignKeyConstraint baseTableName="flashcards" constraintName="fk_flashcard_set"/>

        <dropPrimaryKey tableName="flashcard_sets" constraintName="flashcard_sets_pkey"/>
        <addPrimaryKey tableName="flashcard_sets" columnNames="id" constraintName="pk_flashcard_sets"/>

        <addForeignKeyConstraint 
            baseTableName="flashcard_sets" 
            baseColumnNames="id" 
            constraintName="fk_set_material" 
            referencedTableName="materials" 
            referencedColumnNames="id"
        />

        <dropColumn tableName="flashcard_sets" columnName="name"/>
        <dropColumn tableName="flashcard_sets" columnName="owner_id"/>
    </changeSet>

    <changeSet id="6" author="Michal">
        <addForeignKeyConstraint
            baseTableName="flashcards" 
            baseColumnNames="set_id" 
            constraintName="fk_flashcard_set" 
            referencedTableName="flashcard_sets" 
            referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="7" author="Michal">
        <createTable tableName="material_shares">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="material_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_share_material" references="materials(id)" deleteCascade="true"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_share_user" references="users(id)" deleteCascade="true"/>
            </column>
            <column name="permission" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint
            tableName="material_shares"
            columnNames="material_id, user_id"
            constraintName="uq_material_user_share"
        />
    </changeSet>

    <changeSet id="8" author="Michal">
        <addColumn tableName="material_shares">
            <column name="status" type="VARCHAR(10)" defaultValue="pending">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="9" author="Michal">
        <addColumn tableName="materials">
            <column name="linked_material_id" type="INT">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint
            baseTableName="materials"
            baseColumnNames="linked_material_id"
            constraintName="fk_material_link"
            referencedTableName="materials"
            referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="10" author="Michal">
        <dropForeignKeyConstraint baseTableName="materials" constraintName="fk_material_parent"/>
        <dropForeignKeyConstraint baseTableName="materials" constraintName="fk_material_link"/>

        <addForeignKeyConstraint
            baseTableName="materials"
            baseColumnNames="parent_id"
            constraintName="fk_material_parent_cascade"
            referencedTableName="materials"
            referencedColumnNames="id"
            onDelete="CASCADE"
        />

        
        <addForeignKeyConstraint
            baseTableName="materials"
            baseColumnNames="linked_material_id"
            constraintName="fk_material_link_cascade"
            referencedTableName="materials"
            referencedColumnNames="id"
            onDelete="CASCADE"
        />
    </changeSet>

    <changeSet id="11" author="Michal">
        <createTable tableName="votes">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_vote_user" references="users(id)" deleteCascade="true"/>
            </column>
            <column name="vote_type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="votable_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="votable_type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint
            tableName="votes"
            columnNames="user_id, votable_id, votable_type"
            constraintName="uq_user_votable_vote"
        />
    </changeSet>
    
    <changeSet id="12" author="Michal">
        <createTable tableName="comments">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="text" type="VARCHAR(250)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_comment_user" references="users(id)" deleteCascade="true"/>
            </column>
            <column name="material_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_comment_material" references="materials(id)" deleteCascade="true"/>
            </column>
            <column name="parent_id" type="INT">
                <constraints nullable="true" foreignKeyName="fk_comment_parent" references="comments(id)" deleteCascade="true"/>
            </column>

        </createTable>
    </changeSet>

    <changeSet id="13" author="Michal">
        <renameColumn 
            tableName="comments"
            oldColumnName="parent_id"
            newColumnName="parent_comment_id"
            columnDataType="INT"
        />
    </changeSet>

    <changeSet id="14" author="Michal">
        <addColumn tableName="materials">
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="15" author="Michal">
        <sql>
            CREATE EXTENSION IF NOT EXISTS ltree;
        </sql>

        <addColumn tableName="comments">
            <column name="path" type="LTREE"/>
        </addColumn>

        <createIndex indexName="index_comments_path_gist" tableName="comments" using="gist">
            <column name="path"/>
        </createIndex>

        <sql>
            CREATE OR REPLACE FUNCTION set_comment_path() RETURNS TRIGGER AS '
            DECLARE
                parent_path ltree;
            BEGIN
                IF NEW.parent_comment_id IS NULL THEN
                    UPDATE comments SET path = NEW.id::text::ltree WHERE id = NEW.id;
                ELSE
                    SELECT path INTO parent_path FROM comments WHERE id = NEW.parent_comment_id;
                    UPDATE comments SET path = parent_path || NEW.id::text WHERE id = NEW.id;
                END IF;
                RETURN NEW;
            END;
            ' LANGUAGE plpgsql; </sql>

        <sql>
            CREATE TRIGGER comment_path_trigger
            AFTER INSERT ON comments
            FOR EACH ROW EXECUTE PROCEDURE set_comment_path();
        </sql>
    </changeSet>
    
</databaseChangeLog>